'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import MultiLanguageStoryEditor from '@/components/admin/MultiLanguageStoryEditor';
import {
  DetentionCenter,
  Person,
  ImageStorage,
  Story,
  Town,
  PersonImage,
} from '@prisma/client';
import { createPerson, updatePerson } from '@/app/actions/persons';
import DetentionCenterSelector from '@/components/DetentionCenterSelector';
import PersonBasicInfo from './components/PersonBasicInfo';
import PersonDetentionInfo from './components/PersonDetentionInfo';
import VisibilitySettings from './components/VisibilitySettings';
import FormActions from './components/FormActions';
import { Session } from 'next-auth';
import LoadingOverlay from './components/LoadingOverlay';
import { showSuccessAlert, showErrorAlert } from '@/lib/alertBox';

// Serialized version of Person for client components
type SerializedPerson = Omit<Person, 'bondAmount'> & {
  bondAmount: string | null;
  town: Town;
  detentionCenter?: DetentionCenter | null;
  stories?: Story[];
};

interface PersonFormProps {
  person?: SerializedPerson;
  towns: Town[];
  session?: Session | null;
}

export default function PersonForm({ person, towns, session }: PersonFormProps) {
  const router = useRouter();
  const [errors, setErrors] = useState<Record<string, string[]>>({});
  const [detentionModalOpen, setDetentionModalOpen] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showTabSwitchDialog, setShowTabSwitchDialog] = useState(false);
  const [selectedDetentionCenterId, setSelectedDetentionCenterId] = useState<
    string | null
  >(person?.detentionCenterId || null);
  const [selectedDetentionCenter, setSelectedDetentionCenter] =
    useState<DetentionCenter | null>(person?.detentionCenter || null);
  const [stories, setStories] = useState<
    { language: string; storyType: string; content: string }[]
  >(
    person?.stories?.map(story => ({
      language: story.language,
      storyType: story.storyType,
      content: story.content
    })) || []
  );
  


  const formRef = useRef<HTMLFormElement>(null);

  // Handle stories change
  const handleStoriesChange = useCallback((newStories: typeof stories) => {
    setStories(newStories);
  }, []);


  // Handle detention center change
  const handleDetentionCenterChange = useCallback(async (centerId: string | null) => {
    setSelectedDetentionCenterId(centerId);

    if (centerId) {
      try {
        const response = await fetch(`/api/detention-centers/${centerId}`);
        if (response.ok) {
          const center = await response.json();
          setSelectedDetentionCenter(center);
        }
      } catch (error) {
        console.error('Failed to fetch detention center details:', error);
      }
    } else {
      setSelectedDetentionCenter(null);
    }
  }, []);

  // Track changes for the details tab
  useEffect(() => {
    if (activeTab === 'details') {
      const checkChanges = () => {
        const hasFormChanges = checkFormFieldsChanged();
        const hasStoriesChanged = JSON.stringify(stories) !== originalValues.current.stories;
        const hasDetentionChanged = selectedDetentionCenterId !== originalValues.current.detentionCenterId;
        
        setHasChanges('details', hasFormChanges || hasStoriesChanged || hasDetentionChanged);
      };
      
      // Debounce the check to avoid rapid updates
      const timeoutId = setTimeout(checkChanges, 100);
      return () => clearTimeout(timeoutId);
    }
  }, [activeTab, stories, selectedDetentionCenterId, checkFormFieldsChanged, setHasChanges]);


  async function handleSubmit(formData: FormData) {
    setIsSubmitting(true);
    setErrors({});

    try {
      let result: { success?: boolean; errors?: Record<string, string[]>; person?: { id: string; slug: string; townSlug: string } };

      // Only update the current tab
      if (activeTab === 'details') {
        // Update details only
        console.log('Saving stories:', stories);
        formData.set('stories', JSON.stringify(stories));
        if (selectedDetentionCenterId) {
          formData.append('detentionCenterId', selectedDetentionCenterId);
        } else {
          formData.append('detentionCenterId', '');
        }

        result = person
          ? await updatePerson(person.id, formData)
          : await createPerson(formData);

        if (result.success) {
          // Update original values after successful save
          originalValues.current.stories = JSON.stringify(stories);
          originalValues.current.detentionCenterId = selectedDetentionCenterId;
          
          if (formRef.current) {
            const newFormData = new FormData(formRef.current);
            const fields: Record<string, string> = {};
            
            for (const [key, value] of newFormData.entries()) {
              if (key !== 'stories' && key !== 'detentionCenterId') {
                fields[key] = String(value);
              }
            }
            
            originalValues.current.formFields = fields;
          }
          
          resetTabChanges('details');
        }
      } else if (activeTab === 'person-image' && person) {
        // PersonImageTab is now self-contained and handles its own data
        result = { success: true };
      } else if (activeTab === 'gallery-images' && person) {
        // Gallery images are now self-contained in the component
        // For now, just show a message that changes are saved locally
        result = { success: true };
      } else {
        result = { errors: { _form: ['No changes to save'] } };
      }

      if (result.errors) {
        setIsSubmitting(false);
        setErrors(result.errors);

        const errorDetails: string[] = [];
        Object.entries(result.errors).forEach(([field, messages]) => {
          if (field === '_form') {
            errorDetails.push(...messages);
          } else {
            errorDetails.push(`${field}: ${messages.join(', ')}`);
          }
        });

        const message = `Failed to update: ${errorDetails.join(', ')}`;
        showErrorAlert(message, 5000);
      } else if (result.success) {
        const tabName = activeTab === 'details' ? 'Details' : 
                       activeTab === 'person-image' ? 'Person image' : 
                       'Gallery images';
        showSuccessAlert(`${tabName} updated successfully!`, 3000);
        
        setIsSubmitting(false);
        router.refresh();
      }
    } catch (error) {
      setIsSubmitting(false);
      const errorMessage = error instanceof Error ? error.message : 'Unknown error';
      showErrorAlert(`Unexpected error: ${errorMessage}`, 5000);
    }
  }


  const handleTabChange = (newTab: string) => {
    const currentTabHasChanges = hasChanges[activeTab as keyof typeof hasChanges];
    
    if (currentTabHasChanges) {
      setPendingTabSwitch(newTab);
      setShowTabSwitchDialog(true);
    } else {
      setActiveTab(newTab);
    }
  };

  const handleSaveAndSwitch = async () => {
    setShowTabSwitchDialog(false);
    if (formRef.current) {
      const formData = new FormData(formRef.current);
      await handleSubmit(formData);
    }
    if (pendingTabSwitch) {
      setActiveTab(pendingTabSwitch);
      setPendingTabSwitch(null);
    }
  };

  const handleDiscardAndSwitch = () => {
    setShowTabSwitchDialog(false);
    resetTabChanges(activeTab as keyof typeof hasChanges);
    
    // Reset state based on current tab
    if (activeTab === 'details') {
      // Reset to original values
      setStories(person?.stories?.map(story => ({
        language: story.language,
        storyType: story.storyType,
        content: story.content
      })) || []);
      setSelectedDetentionCenterId(person?.detentionCenterId || null);
      setSelectedDetentionCenter(person?.detentionCenter || null);
    }
    
    if (pendingTabSwitch) {
      setActiveTab(pendingTabSwitch);
      setPendingTabSwitch(null);
    }
  };

  const getTabDisplayName = (tab: string) => {
    return tab === 'details' ? 'Details' :
           tab === 'person-image' ? 'Person Image' :
           'Gallery Images';
  };

  const currentTabHasChanges = hasChanges[activeTab as keyof typeof hasChanges];

  return (
    <>
      <UnsavedChangesIndicator />
      
      <form ref={formRef} onSubmit={async (e) => {
        e.preventDefault();
        if (isSubmitting) return;
        const formData = new FormData(e.currentTarget);
        await handleSubmit(formData);
      }} onChange={handleFormChange} className="space-y-6 relative">
        <LoadingOverlay
          isLoading={isSubmitting}
          message={person ? 'Updating person...' : 'Creating person...'}
        />
        <Tabs value={activeTab} onValueChange={handleTabChange} className="w-full">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="details">Details</TabsTrigger>
            <TabsTrigger value="person-image">Person Image</TabsTrigger>
            <TabsTrigger value="gallery-images">Gallery Images</TabsTrigger>
          </TabsList>
          
          <TabsContent value="details" className="space-y-6">
            <PersonBasicInfo person={person} towns={towns} errors={errors} />

            <PersonDetentionInfo
              person={person}
              selectedDetentionCenter={selectedDetentionCenter}
              selectedDetentionCenterId={selectedDetentionCenterId}
              onOpenModal={() => setDetentionModalOpen(true)}
            />

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Stories
              </label>
              <MultiLanguageStoryEditor
                stories={person?.stories}
                onChange={handleStoriesChange}
              />
              <p className="mt-2 text-sm text-gray-500">
                Add stories in multiple languages. Visitors will be able to switch
                between available languages on the profile page.
              </p>
            </div>

            <VisibilitySettings person={person} />
          </TabsContent>
          
          <TabsContent value="person-image" className="space-y-6">
            {person?.id && (
              <PersonImageTab
                personId={person.id}
              />
            )}
          </TabsContent>
          
          <TabsContent value="gallery-images" className="space-y-6">
            {person?.id && (
              <GalleryImagesTab
                personId={person.id}
              />
            )}
          </TabsContent>
        </Tabs>

        <FormActions 
          isSubmitting={isSubmitting} 
          isEditMode={!!person} 
          person={person}
          session={session}
          disabled={!currentTabHasChanges}
        />
      </form>

      <DetentionCenterSelector
        isOpen={detentionModalOpen}
        onClose={() => setDetentionModalOpen(false)}
        onSelect={handleDetentionCenterChange}
        currentDetentionCenterId={selectedDetentionCenterId}
      />
      
      <TabSwitchDialog
        isOpen={showTabSwitchDialog}
        onSave={handleSaveAndSwitch}
        onDiscard={handleDiscardAndSwitch}
        onCancel={() => {
          setShowTabSwitchDialog(false);
          setPendingTabSwitch(null);
        }}
        currentTabName={getTabDisplayName(activeTab)}
      />
    </>
  );
}

export default function PersonForm(props: PersonFormProps) {
  return (
    <TabsProvider>
      <PersonFormContent {...props} />
    </TabsProvider>
  );
}